name: Daily Generate & Deploy

on:
  push:
    branches:
      - main
  schedule:
    # Run at 03:17 UTC every day
    - cron: "17 3 * * *"
  workflow_dispatch:
    inputs:
      pages:
        description: "Number of pages to generate (overrides PAGES_PER_DAY)"
        required: false
        default: "3"
      dry_run:
        description: "Dry run (no Gemini calls, no commit)"
        required: false
        default: "false"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # ── Checkout ──────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ── Python setup ──────────────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      # ── Lint & format check ───────────────────────────────
      - name: Run ruff lint
        run: ruff check src/ scripts/ tests/

      # ── Unit tests ────────────────────────────────────────
      - name: Run unit tests
        run: pytest tests/ -v --tb=short

      # ── Pre-flight: verify secrets ────────────────────────
      - name: Verify GEMINI_API_KEY is configured
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "ERROR: GEMINI_API_KEY secret is not set."
            echo "Go to: Settings > Secrets and variables > Actions > New repository secret"
            echo "Name: GEMINI_API_KEY  |  Value: your Gemini API key from aistudio.google.com"
            exit 1
          fi
          echo "GEMINI_API_KEY is configured (${#GEMINI_API_KEY} chars)"

      # ── API smoke test ────────────────────────────────────
      - name: Smoke test Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-2.5-flash' }}
        run: |
          python - <<'EOF'
          import os, sys
          from google import genai
          key = os.environ["GEMINI_API_KEY"]
          model = os.environ.get("GEMINI_MODEL", "gemini-2.5-flash")
          client = genai.Client(api_key=key)
          print(f"--- Testing model: {model} ---")
          try:
              resp = client.models.generate_content(model=model, contents="Reply OK")
              print("Smoke test PASSED:", repr(resp.text)[:80])
          except Exception as exc:
              print(f"Smoke test FAILED: {type(exc).__name__}: {exc}")
              print("--- Available models ---")
              try:
                  for m in client.models.list():
                      print(" ", getattr(m, "name", "?"))
              except Exception as le:
                  print(f"  ListModels also failed: {le}")
              sys.exit(1)
          EOF

      # ── Generate new pages ────────────────────────────────
      - name: Generate new pages
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-2.5-flash' }}
          PAGES_PER_DAY: ${{ github.event.inputs.pages || '3' }}
          SITE_URL: ${{ vars.SITE_URL || 'https://aidevtools.me' }}
          SITE_NAME: ${{ vars.SITE_NAME || 'AI ToolStack Engine' }}
          ADSENSE_PUBLISHER_ID: ${{ secrets.ADSENSE_PUBLISHER_ID || '' }}
        run: |
          DRY_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_FLAG="--dry-run"
          fi
          python scripts/daily_run.py --pages "$PAGES_PER_DAY" $DRY_FLAG

      # ── Print generation errors if any ───────────────────
      - name: Print generation error log
        if: always()
        run: |  
          if [ -f generation_errors.txt ]; then
            echo "=== generation_errors.txt ==="
            cat generation_errors.txt
          else
            echo "No generation_errors.txt found"
          fi

      # ── Build static site ─────────────────────────────────
      - name: Build static site
        env:
          SITE_URL: ${{ vars.SITE_URL || 'https://aidevtools.me' }}
          SITE_NAME: ${{ vars.SITE_NAME || 'AI ToolStack Engine' }}
          ADSENSE_PUBLISHER_ID: ${{ secrets.ADSENSE_PUBLISHER_ID || '' }}
        run: python scripts/build_site.py

      # ── Commit generated content back to repo ─────────────
      - name: Commit generated content
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p content site
          git add content/ site/
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(bot): daily page generation $(date -u +%Y-%m-%d) [skip ci]"
            git pull --rebase origin main
            git push origin HEAD:main
          fi

      # ── Deploy to GitHub Pages ────────────────────────────
      - name: Setup GitHub Pages
        if: github.event.inputs.dry_run != 'true'
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: github.event.inputs.dry_run != 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/

      - name: Deploy to GitHub Pages
        if: github.event.inputs.dry_run != 'true'
        id: deployment
        uses: actions/deploy-pages@v4
